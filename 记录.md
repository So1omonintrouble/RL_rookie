## 230213

针对之前PPO算法加入惩罚开始有些收敛的模型，降低神经网络学习率并提高训练次数到3000次，发现只能收敛到一定程度，远远没办法达到预期。

经过反复尝试PPO算法仍无法收敛，打算换DDPG试试，然后查找文档学习怎么修改代码，就发现MATLAB范例中有个水库水位的模型，是最新版的，跟之前的还不一样，他设计了个之前没见过的奖励函数，而且还是自动生成代码的，我就比较好奇，打算第二天读一下

## 230214

![image-20230216140300154](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216140300154.png)

范例是最新版MATLAB才有的

### 生成奖励函数

```matlab
blk = 'rlWatertankStepInput/WaterLevelStepResponse';
generateRewardFunction(blk)
```

使用这样的代码就可以生成奖励函数，WaterLevelStepResponse是Simulink的一个模块，它参数可以自由设置![image-20230216141107654](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216141107654.png)

规定了在指定时间内，所期望的目标控制范围

![image-20230216140830977](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216140830977.png)

生成的代码较为复杂，其中比较核心的代码应该是

```matlab
Penalty = sum(exteriorPenalty(x,Block1_xmin,Block1_xmax,'quadratic'));
```

直接计算是否在目标范围内，并随着与目标距离的提高而提高惩罚

其他的主要就是用来计算对应时间对应最大最小值了

### 状态空间选取

![image-20230216144024423](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216144024423.png)

同样是面对一段时间序列的水位变化波形，刚开始学强化学习时候也有个水库水位控制，跟新版的相比主要差别在于状态空间的选取，旧版主要选用误差积分，误差，水位高度三个量，新版采用6个量，水位高度本身，对该信号进行4次延迟得到的5个信号以及误差，感觉这样就可以观测到更多的信息来进行学习

### 继续尝试

将这种新的设置状态空间的方法引入到VdcQ-Vf控制模型中进行训练，仍然无法收敛

经过一定思考，应该是0-1s本应该无效的数据被强化学习Agent记录的缘故，状态值对应的是一段暂态波形，而没有设置奖励，故奖励为0，而且奖励最大也就是0，因此**0-1s数据本身就会误导Agent进行学习**，所以怎么将0-1s数据除去目前来看较为重要，经过一系列方法从逻辑上还是没办法去除0-1s数据的影响

> 230215：可以通过记录稳态所有状态，下次仿真直接从稳态开始的方法来解决

## 230215

~~想起刘老师之前讲的可以先将仿真运行到稳态，然后下一次仿真直接从稳态开始，这样就可以完美避开0-1s的影响，询问楚钒后知道Simulink有着这样的功能，查找后可以使用，但发现PSS的K值一旦发生改变就会不避免地产生一段莫名其妙的波形，想了想只能是PSS内部积分模块的影响了，想到**模型启动的一段暂态过程会对PSS积分模块状态造成影响**，修改方法就是暂态过程中让PSS接收到的有功功率P值一直为0，之后再把P投入PSS模块中就可以解决。~~

~~经过以上修改后，发现达到稳态投切负荷，可以产生相应振荡，同时投入PSS，可以抑制振荡，但抑制效果与之前大不相同，不改变T1，T2时（T1=T2=1），改变K值大小，从一个较小K值开始，随着K值提高，抑制速度变快，但超调量随之也逐渐增大，大到一定程度，无法对振荡进行抑制，此时的**K值过大过小都不利于振荡抑制**。~~

| K=0.0005 | ![image-20230216151951482](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216151951482.png) |
| :------: | ------------------------------------------------------------ |
| K=0.001  | ![image-20230216151906954](D:/common/本地图库/image-20230216151906954.png) |
| K=0.002  | ![image-20230216151645055](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216151645055.png) |
|  K=0.01  | ![image-20230216151731145](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216151731145.png) |
|  K=0.03  | ![image-20230216151838828](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216151838828.png) |

## 230216

把上述方法用到有Agent的Simulink模型中，仍存在问题，应该是Simulink强化学习模块的问题

| 没有强化学习模块<img src="https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216160653592.png" alt="image-20230216160653592" style="zoom: 33%;" /> | ![image-20230216160304520](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216160304520.png) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 有强化学习模块（包括奖励函数，状态空间生成）<img src="https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216160610557.png" alt="image-20230216160610557" style="zoom: 25%;" /> | ![image-20230216160129680](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216160129680.png) |
| 甚至只加一个RL Agent模块都有问题<img src="https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216160544245.png" alt="image-20230216160544245" style="zoom: 50%;" /> | ![image-20230216160421158](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230216160421158.png) |

同时经过对比发现加入unit delay也会产生类似这种情况

> 230220：可以通过修改求解器为23tb来解决

## 230220

~~尝试加入补偿角度~~

| ~~$\phi$=0情况下K=0.002 $$f_c=5.6Hz$$~~ | ~~![image-20230220111655087](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230220111655087.png)~~ |
| --------------------------------------- | ------------------------------------------------------------ |
| ~~$\phi$=10情况下K=0.002$$f_c=5.6Hz$$~~ | ~~![image-20230220112503780](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230220112503780.png)~~ |
| ~~$\phi$=12情况下K=0.002$$f_c=5.6Hz$$~~ | ~~![image-20230220113123299](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230220113123299.png)~~ |
| ~~$\phi$=15情况下K=0.002$$f_c=5.6Hz$$~~ | ~~![image-20230220112727092](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230220112727092.png)~~ |
| ~~$\phi$=20情况下K=0.002$$f_c=5.6Hz$$~~ | ~~![image-20230220112524920](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230220112524920.png)~~ |
| ~~$\phi$=30情况下K=0.002$$f_c=5.6Hz$$~~ | ~~![image-20230220112544531](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230220112544531.png)~~ |
| ~~$\phi$=40情况下K=0.002$$f_c=5.6Hz$$~~ | ~~![image-20230220112604656](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230220112604656.png)~~ |
| ~~$\phi$=50情况下K=0.002$$f_c=5.6Hz$$~~ | ~~![image-20230220112644460](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230220112644460.png)~~ |

### ~~仍然存在问题~~

~~总条件：1s时Kp=2变为Kp=0.16；**5s时发生负荷突变**~~

| ~~P的值从0s开始输入到PSS~~ | ~~PSS输出从5s开始输入到Udc参考值~~ | ~~![image-20230220123850393](https://cdn.jsdelivr.net/gh/So1omonintrouble/gitpush/image/image-20230220123850393.png)~~ |
| -------------------------- | ---------------------------------- | ------------------------------------------------------------ |
| ~~P的值从0s开始输入到PSS~~ | ~~PSS输出从0s开始输入到Udc参考值~~ | ~~![image-20230220123936304](D:/common/本地图库/image-20230220123936304.png)~~ |
| ~~P的值从5s开始输入到PSS~~ | ~~PSS输出从5s开始输入到Udc参考值~~ | ~~![image-20230220124157577](D:/common/本地图库/image-20230220124157577.png)~~ |
| ~~P的值从5s开始输入到PSS~~ | ~~PSS输出从0s开始输入到Udc参考值~~ | ~~![image-20230220124251263](D:/common/本地图库/image-20230220124251263.png)~~ |

~~另外的问题：PSS的工作~~

## 230221

调整求解器，目前仿真不规则波形已除去

加入强化学习agent，并添加变量，可以简单实现强化学习Agent的输出

![image-20230221131201105](D:/common/本地图库/image-20230221131201105.png)

以上实际时间为4-7s有功功率波形

![image-20230221131321656](D:/common/本地图库/image-20230221131321656.png)

以上为0-4s有功功率波形，1s时系统变为弱阻尼特性并投入PSS，整段波形k值不变，为0.002

## 230222

重新搭建奖励函数与状态空间

![image-20230222122800333](D:/common/本地图库/image-20230222122800333.png)

![image-20230222122824887](D:/common/本地图库/image-20230222122824887.png)
